<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>esbuild-wasm-demo</title>
    <script src="../dist/esbuild-wasm-compiler.min.js"></script>
  </head>
  <body>
    <div id="root">
      loading...
    </div>

    <script>
      let Main = `
        import React from 'react'
        import ReactDOM from 'react-dom/client'
        import App from './App'

        ReactDOM.createRoot(document.getElementById('root')!).render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        )
    `
      let AppCode = `
        import React from 'react'
        import {Button} from './Button'
        import './index.css'

         const App = ()=>{
          const [num,setNum]=React.useState<number>(1)
          return <>
              <button onClick={()=>setNum(num+1)}>click</button>
              <span className='ty'>{num}</span>
              <Button/>
            </>
        }
        export default App
        `;

      const ButtonCode = `
        import React from 'react'
        import {round} from 'lodash-es'

        export const Button = ()=>{
          return <button>{round(1.23456,2)}</button>
        }`;

      const indexCssCode = `.ty{color:red}`;

      const files = {
        "/main.tsx": Main,
        "/App.tsx": AppCode,
        "/Button.tsx": ButtonCode,
        "/index.css": indexCssCode,
      };
    </script>
    <script>
      const compiler = new Compiler({
        getFileContent: path => {
          const filePath = Object.keys(files).find(item=>item.startsWith(path))
          const content = filePath ? files[filePath] : null
          if (!content) {
            throw new Error("File not found");
          }
          return content;
        }
      },{
        wasmURL:'./esbuild.wasm'
      })

      // 如果没有配置packageJson可以不执行插入Imports
      document.body.appendChild(compiler.getImportsScriptElement())

      const init = async () => {
        const code = await compiler.compile('/main.tsx')
        console.log(code)
        // 编译报错信息
        if(typeof code !== 'string' && code.error) {
          document.querySelector('#root').innerHTML = code.message
          return
        }
        const script = document.createElement("script");
        script.type = "module";
        script.innerHTML = code
        document.body.appendChild(script);
      }

      init()
    </script>
  </body>
</html>
